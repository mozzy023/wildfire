<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Liste Vincenti • Commhundred</title>

  <!-- Foglio di stile globale -->
  <link rel="stylesheet" href="styles.css?v=4" />

  <!-- Favicon (se usi la variante con sfondo bianco) -->
  <link rel="icon" type="image/png" sizes="48x48" href="/assets/icons-whitebg/favicon-48x48.png?v=3">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons-whitebg/favicon-32x32.png?v=3">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons-whitebg/favicon-16x16.png?v=3">
  <link rel="icon" href="/assets/icons-whitebg/favicon.ico?v=3" sizes="any">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons-whitebg/apple-touch-icon.png?v=3">
  <meta name="theme-color" content="#e30613">

  <!-- Stili specifici per questa pagina (layout artwork + info) -->
  <style>
    /* --- Card mazzo: layout immagine + info affiancati --- */
    .vincenti-item { padding: 1rem; }
    .deck-row{
      display:grid;
      grid-template-columns: 320px 1fr;      /* immagine fissa, testo flessibile */
      gap:16px;
      align-items:start;
    }
    .deck-art{
      width:100%;
      border-radius:12px;
      overflow:hidden;
      background:#f7f7f8;                    /* “letterbox” elegante se rapporti diversi */
      padding:6px;                           /* cornice leggera */
    }
    .deck-art img{
      width:100%;
      height:auto;                           /* ⬅️ non tagliamo l’immagine */
      display:block;
      border-radius:10px;
      object-fit:contain;
      background:#f7f7f8;
      box-shadow:0 2px 6px rgba(0,0,0,.08);
    }
    .deck-art.pair{
      display:grid;
      grid-template-rows: 1fr 1fr;           /* due comandanti → immagini impilate */
      gap:8px;
      padding:0;
      background:none;
    }
    .deck-info{ display:flex; flex-direction:column; gap:.4rem; }
    .deck-link{ align-self:flex-start; }

    /* Filtri in alto: larghezza piacevole */
    .filter-container { max-width: 920px; }

    /* Responsive */
    @media (max-width: 1024px){
      .deck-row{ grid-template-columns: 280px 1fr; }
    }
    @media (max-width: 768px){
      .deck-row{ grid-template-columns: 1fr; }
      .deck-art{ padding:0; }
      .deck-link{ width:100%; text-align:center; }
    }

    /* Crediti Scryfall */
    .art-credits {
      margin: 1rem auto 0;
      text-align: center;
      font-size: .85rem;
      color: #666;
      max-width: 920px;
    }
    .art-credits a { color: var(--rosso-wildfire); text-decoration: none; }
    .art-credits a:hover { text-decoration: underline; }
  </style>
</head>

<body>
  <div class="wrapper">
    <div class="container">
      <!-- Header comune -->
      <header>
        <div class="brand">
          <img src="./logo.png" alt="WildFire Logo" class="logo-img" />
          <div class="logo-text">Commhundred</div>
        </div>
        <nav>
          <a href="index.html">Home</a>
          <a href="carte-limitate.html">Carte Limitate</a>
          <a href="classifica-giocatori.html">Classifica Giocatori</a>
          <a class="active" href="liste-vincenti.html">Liste Vincenti</a>
          <a href="eventi.html">Eventi</a>
        </nav>
        <!-- Il pulsante hamburger viene creato via JS -->
      </header>

      <!-- Contenuto -->
      <main>
        <section class="visible">
          <h2>Liste Vincenti</h2>

          <!-- Filtri Y/S -->
          <div class="filter-container" id="filterBox">
            <label for="filter-y">Anno (Y):</label>
            <select id="filter-y">
              <option value="tutte">Tutte</option>
            </select>

            <label for="filter-s">Stagione (S):</label>
            <select id="filter-s">
              <option value="tutte">Tutte</option>
            </select>
          </div>

          <!-- Lista -->
          <ul id="vincenti-list" class="vincenti-list" aria-live="polite"></ul>

          <!-- Crediti immagini -->
          <p class="art-credits">
            Card images courtesy of
            <a href="https://scryfall.com" target="_blank" rel="noopener">Scryfall</a>.
          </p>
        </section>
      </main>

      <!-- Footer semplice -->
      <footer class="footer-wrapper">
        <div class="footer-bottom">© Commhundred • Wildfire</div>
      </footer>
    </div>
  </div>

  <!-- Script pagina -->
  <script>
    // Endpoint foglio "mazzi vincenti"
    const GOOGLE_SCRIPTS_VINCENTI =
      "https://script.google.com/macros/s/AKfycbwkgPp0eoWDh-xrTVZ2Tnmv4T9JF66JPd52muFtnxDjH5pcPMjYbe5hGGWol5aOmpVg/exec";

    /* ==========================
       NAV: hamburger + chiusura fuori + brand → home
       ========================== */
    document.addEventListener("DOMContentLoaded", function () {
      const header = document.querySelector("header");
      const nav = document.querySelector("nav");
      if (header && nav) {
        // Crea il pulsante ☰ se non esiste
        let menuToggle = document.querySelector(".menu-toggle");
        if (!menuToggle) {
          menuToggle = document.createElement("button");
          menuToggle.className = "menu-toggle";
          menuToggle.textContent = "☰";
          header.appendChild(menuToggle);
        }

        function openMenu(){ nav.classList.add("show"); }
        function closeMenu(){ nav.classList.remove("show"); }
        function isOpen(){ return nav.classList.contains("show"); }

        menuToggle.addEventListener("click", (e)=>{
          e.stopPropagation();
          isOpen() ? closeMenu() : openMenu();
        });

        // Chiudi al tap/click fuori
        function outsideHandler(e){
          if (!isOpen()) return;
          const t = e.target;
          if (!nav.contains(t) && !menuToggle.contains(t)) closeMenu();
        }
        document.addEventListener("pointerdown", outsideHandler);
        document.addEventListener("click", outsideHandler);

        // Chiudi scegliendo una voce
        nav.querySelectorAll("a").forEach(a => a.addEventListener("click", closeMenu));

        // Chiudi con ESC
        document.addEventListener("keydown", e => { if (e.key === "Escape" && isOpen()) closeMenu(); });

        // Logo/scritta → home
        const brand = document.querySelector(".brand");
        if (brand) {
          brand.style.cursor = "pointer";
          brand.addEventListener("click", () => { window.location.href = "index.html"; });
        }
      }
    });

    /* ==========================
       Scryfall: fetch artwork + cache
       ========================== */
    const ART_TTL_MS = 1000 * 60 * 60 * 24 * 30; // 30 giorni

    function sanitizeName(name) {
      return String(name || "").trim().replace(/\s+/g, " ");
    }
    function cacheGet(key) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (Date.now() - obj.ts < ART_TTL_MS) return obj.url;
        localStorage.removeItem(key);
      } catch(_) {}
      return null;
    }
    function cacheSet(key, url) {
      try { localStorage.setItem(key, JSON.stringify({ url, ts: Date.now() })); } catch(_) {}
    }

    async function fetchScryfallArt(name) {
      const n = sanitizeName(name);
      if (!n) return null;

      const key = "art:" + n.toLowerCase();
      const cached = cacheGet(key);
      if (cached) return cached;

      const base = "https://api.scryfall.com/cards/named";
      const params = "&include_extras=true&include_multilingual=true";

      let res = await fetch(`${base}?exact=${encodeURIComponent(n)}${params}`);
      if (!res.ok) res = await fetch(`${base}?fuzzy=${encodeURIComponent(n)}${params}`);
      if (!res.ok) return null;

      const data = await res.json();
      if (data.object !== "card") return null;

      let art = null;
      if (data.image_uris && data.image_uris.art_crop) {
        art = data.image_uris.art_crop;
      } else if (Array.isArray(data.card_faces) && data.card_faces.length) {
        const face = data.card_faces.find(f => (f.name || "").toLowerCase() === n.toLowerCase()) || data.card_faces[0];
        if (face.image_uris && face.image_uris.art_crop) art = face.image_uris.art_crop;
        else if (face.image_uris && face.image_uris.normal) art = face.image_uris.normal;
      } else if (data.image_uris && data.image_uris.normal) {
        art = data.image_uris.normal;
      }

      if (art) {
        cacheSet(key, art);
        return art;
      }
      return null;
    }

    async function insertCommanderArt(container, commander1, commander2) {
      const names = [sanitizeName(commander1), sanitizeName(commander2)].filter(Boolean);
      if (names.length === 0) return;

      if (names.length === 1) {
        const url = await fetchScryfallArt(names[0]);
        if (url) {
          const img = new Image();
          img.loading = "lazy";
          img.alt = `Artwork ${names[0]}`;
          img.src = url;
          container.appendChild(img);
        } else {
          container.style.display = "none";
        }
      } else {
        container.classList.add("pair");
        const [u1, u2] = await Promise.all([fetchScryfallArt(names[0]), fetchScryfallArt(names[1])]);
        if (u1) {
          const i1 = new Image();
          i1.loading = "lazy";
          i1.alt = `Artwork ${names[0]}`;
          i1.src = u1;
          container.appendChild(i1);
        }
        if (u2) {
          const i2 = new Image();
          i2.loading = "lazy";
          i2.alt = `Artwork ${names[1]}`;
          i2.src = u2;
          container.appendChild(i2);
        }
        if (!container.children.length) container.style.display = "none";
      }
    }

    /* ==========================
       Render liste + filtri Y/S
       ========================== */
    function populateFilters() {
      const sSet = new Set(), ySet = new Set();
      document.querySelectorAll(".vincenti-item").forEach(li => {
        if (li.dataset.s) sSet.add(li.dataset.s);
        if (li.dataset.y) ySet.add(li.dataset.y);
      });
      fillSelect("filter-s", sSet);
      fillSelect("filter-y", ySet);
    }

    function fillSelect(id, valuesSet) {
      const select = document.getElementById(id);
      if (!select) return;

      const current = select.value || "tutte";
      const values = Array.from(valuesSet).sort((a, b) => {
        const na = parseInt(a.replace(/[^\d]/g, "")) || 0;
        const nb = parseInt(b.replace(/[^\d]/g, "")) || 0;
        if (a[0] === b[0]) return na - nb;
        return a[0].localeCompare(b[0]);
      });

      select.innerHTML =
        '<option value="tutte">Tutte</option>' +
        values.map(v => `<option value="${v}">${v}</option>`).join("");

      if ([...select.options].some(o => o.value === current)) {
        select.value = current;
      }
    }

    function applyFilters() {
      const y = (document.getElementById("filter-y")?.value || "tutte").toUpperCase();
      const s = (document.getElementById("filter-s")?.value || "tutte").toUpperCase();

      document.querySelectorAll("#vincenti-list .vincenti-item").forEach(li => {
        const okY = (y === "TUTTE") || (li.dataset.y === y);
        const okS = (s === "TUTTE") || (li.dataset.s === s);
        li.style.display = (okY && okS) ? "" : "none";
      });
    }

    document.addEventListener("change", (e) => {
      if (e.target && (e.target.id === "filter-y" || e.target.id === "filter-s")) {
        applyFilters();
      }
    });

    function handleVincentiData(data) {
      const listContainer = document.getElementById("vincenti-list");
      if (!listContainer) return;

      listContainer.innerHTML = "";
      (data || []).sort((a, b) => a.id - b.id);

      (data || []).forEach(mazzo => {
        const li = document.createElement("li");
        li.classList.add("vincenti-item");

        // Riga: immagine + info
        const row = document.createElement("div");
        row.className = "deck-row";

        const art = document.createElement("div");
        art.className = "deck-art";

        const info = document.createElement("div");
        info.className = "deck-info";
        info.innerHTML = `
          <span class="deck-name">${mazzo.nome || ""}</span>
          <span class="deck-author">${mazzo.autore || ""}</span>
          <span class="deck-commander">
            ${(mazzo.comandante1 || "")}${mazzo.comandante2 ? " & " + mazzo.comandante2 : ""}
          </span>
          <span class="deck-date">${mazzo.data || ""}</span>
          <span class="deck-players">Partecipanti: ${mazzo.partecipanti || ""}</span>
          <a class="deck-link" href="${mazzo.link || "#"}" target="_blank" rel="noopener">Vedi Mazzo</a>
          ${mazzo.year_season && mazzo.year_season !== "N/A" ? `<span class="deck-season">${mazzo.year_season}</span>` : ""}
        `;

        row.append(art, info);
        li.appendChild(row);

        // Tag S/Y per i filtri
        const tag = String(mazzo.year_season || "").toUpperCase();
        const sMatch = tag.match(/S\s*(\d+)/);
        const yMatch = tag.match(/Y\s*(\d+)/);
        if (sMatch) li.dataset.s = `S${sMatch[1]}`;
        if (yMatch) li.dataset.y = `Y${yMatch[1]}`;

        listContainer.appendChild(li);

        // Artwork comandante (uno o due)
        insertCommanderArt(art, mazzo.comandante1, mazzo.comandante2);
      });

      populateFilters();
      applyFilters();
    }

    async function caricaMazziVincenti() {
      try {
        const resp = await fetch(GOOGLE_SCRIPTS_VINCENTI);
        const data = await resp.json();
        handleVincentiData(data);
      } catch (e) {
        console.error("Errore nel caricamento:", e);
        const listContainer = document.getElementById("vincenti-list");
        if (listContainer) {
          listContainer.innerHTML = "<li class='vincenti-item'>Errore nel caricamento dei dati.</li>";
        }
      }
    }

    // Avvio
    document.addEventListener("DOMContentLoaded", caricaMazziVincenti);
  </script>
</body>
</html>
